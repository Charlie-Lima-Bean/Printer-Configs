
[gcode_macro _tap_variables]
variable_safety_armed: False   # probe trigger will result in e-stop when armed
gcode:

[gcode_macro _arm_tap_safety]
description: Arms tap safety
gcode:
    SET_GCODE_VARIABLE MACRO=_tap_variables VARIABLE=safety_armed VALUE={ True }
    { action_respond_info('Tap Safety armed!') }

[gcode_macro _disarm_tap_safety]
description: Disarms tap safety
gcode:
    SET_GCODE_VARIABLE MACRO=_tap_variables VARIABLE=safety_armed VALUE={ False }
    { action_respond_info('Tap Safety disarmed!') }

[gcode_macro _assert_tap_safety_disarmed]
description: Soft abort if tap safety is armed. Typically indicates a programming error, rather than a safety hazard.
gcode:
    {% set msg  = params.MSG | default("Tap Safety unexpectedly armed") | string %}
    {% set safety_armed = printer["gcode_macro _tap_variables"].safety_armed %}
    {% if safety_armed %}
        { action_raise_error(msg) }
    {% endif %}

[gcode_macro _tap_triggered]
description: Full e-stop iff safety is armed. Should be called whenever tap is triggered.
gcode:
    {% set safety_armed = printer["gcode_macro _tap_variables"].safety_armed %}
    {% if safety_armed %}
        { action_emergency_stop() }
        { action_respond_info('Tap Safety triggerd, emergencey stopping!') }
        M117 Tap Safety triggered, e-stopped!
    {% endif %}